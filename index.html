<!DOCTYPE html>
<html>

<head>
    <title>Multimedia chat!</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
</head>

<body>
    <input type='text' placeholder="Message" id='inp' />
    <form id="form">
        <input type="file" name="file" />
        <button type="submit">Upload File and Send</button>
        <!-- for upload progress -->
        <div id="upload-progress"></div>
    </form>
    <button onclick="sendMsg()">Send</button>
    <!-- used for typing indicators -->
    <p id="indicator"></p>
    <ul id='messages'></ul>

    <script>
        // dom event handlers
        $('#inp').on('input', emitStartType);
        $('#inp').on('blur', emitStopType);
        $('#form').on('submit', handleFormSubmit);
        
        let typingTimeout = null;
        let isStartTypeSent = false;
        let typingUsers = new Set();

        function handleFormSubmit(e) {
            e.preventDefault();
            const form = $(this)
            const formData = new FormData(form[0])
            for (const p of formData) {
                if (p[1].size <= 0) {
                    // no form data available!
                    return
                }
            }
            $.ajax({
                method: 'POST',
                data: formData,
                cache: false,
                contentType: false,
                processData: false,
                url: '/upload',
                success: handleUploadSuccess,
                xhr: handleUploadProgress
            })
        }

        function handleUploadSuccess(resp) {
            socket.emit('file', { name, file: { url: `/${resp.newFilename}`, filename: resp.originalFilename } });
            $('#form')[0].reset();
            $('#upload-progress').text('');
        }

        function handleUploadProgress() {
            const xhr = new window.XMLHttpRequest();
            xhr.upload.addEventListener('progress', e => {
                const percent = (event.loaded / event.total) * 100;
                const progress = Math.round(percent);
                $('#upload-progress').text(`${progress}% uploaded`);
            }, false);
            xhr.addEventListener('error', e => {
                $('#upload-progress').text('Upload errored!');
                console.error(e);
            }, false);
            xhr.addEventListener('abort', e => {
                $('#upload-progress').text('Upload aborted');
                console.error(e);
            }, false);

            return xhr;
        }

        function emitStartType() {
            clearTimeout(typingTimeout)
            typingTimeout = setTimeout(emitStopType, 1000)
            if (isStartTypeSent) return
            socket.emit('start-type', name, () => {
                isStartTypeSent = true
            });
        }

        function emitStopType() {
            socket.emit('stop-type', name, () => {
                isStartTypeSent = false
            });
        }

        // event handlers here
        function handleChat(data) {
            $('#messages').append(`
                <li>
                    User: ${data.name}
                    <br />
                    Message: ${data.text}
                </li>
            `);
        }

        function handleJoinUser(name) {
            $('#messages').append(`
                <li>User joined: ${name}</li>
            `);
        }

        function handleLeaveUser(name) {
            handleStopType(name);
            $('#messages').append(`
                <li>User left: ${name}</li>
            `);
        }

        function getName() {
            return prompt('Please enter your name.');
        }

        function sendMsg() {
            const text = $('#inp').val();
            socket.emit('chat', { name, text });
        }

        function handleStartType(name) {
            typingUsers.add(name);
            let displayString = '';
            for (const user of Array.from(typingUsers)) {
                displayString += `${user}, `;
            }
            displayString = displayString.substr(0, displayString.length - 2)
            displayString += ' typing...'
            $('#indicator').text(displayString);
        }

        function handleStopType(name) {
            typingUsers.delete(name)
            let displayString = ''
            for (const user of Array.from(typingUsers)) {
                displayString += `${user}, `;
            }
            displayString = displayString.substr(0, displayString.length - 2)
            displayString += displayString.length > 0 ? ' typing...' : ''
            $('#indicator').text(displayString)
        }

        function handleFile(f) {
            $('#messages').append(`
                <li>
                    User: ${f.name}
                    <br />
                    File: <a target='_blank' href='${f.file.url}' download='${f.file.filename}'>${f.file.filename}</a>
                </li>
            `);
        }
    </script>

    <script>
        let socket;
        let name = '';
        $(document).ready(() => {
            socket = io();
            socket.on('connect', () => {
                name = getName();
                socket.emit('join', name)
            });

            socket.on('join', handleJoinUser);
            socket.on('chat', handleChat);
            socket.on('leave', handleLeaveUser);
            socket.on('start-type', handleStartType);
            socket.on('stop-type', handleStopType);
            socket.on('file', handleFile);
        });
    </script>
</body>

</html>